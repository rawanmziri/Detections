//Emotet MalSpam Detection based upon last disementation (Nov. 2022)
//This query is largely credited with and inspired by:
  //https://blog.nviso.eu/2022/03/23/hunting-emotet-campaigns-with-kusto/
//I have tweaked it to include a few other rare attachments that Emotet may use including the new OneNote malware campaign
//This is a mere hypothesis with the other attachments as Emotet has yet to restart their malspam campaign
EmailAttachmentInfo 
| where FileType == "zip" and FileName endswith_cs "zip"
| or FileType == "xls" and FileName endswith_cs "xls"
| or FileType == "iso" and FileName endswith_cs "iso"
| or FileType == "one;onenote"
| SenderDisplayName startswith_cs "<" 
| join kind=inner (EmailEvents | where EmailDirection == "Inbound" and DeliveryAction != "Blocked" and Subject has_any ("Re", Fw")) on NetworkMessageId, SenderFromAddress, RecipientEmailAddress 
| join kind=inner DeviceEvents on SHA256
| project SenderFromAddress, RecipientEmailAddress, FileType, FileName, SHA256, DeliveryLocation, DeviceName, FolderPath
